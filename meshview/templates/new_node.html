{% extends "base.html" %}

{% block css %}
{{ super() }}

/* --- Map --- */
#map {
    width: 100%;
    height: 400px;
    margin-bottom: 20px;
    border-radius: 8px;
    display: block;
}
.leaflet-container {
    background: #1a1a1a;
    z-index: 1;
}

/* --- Node Info --- */
.node-info {
    background-color: #1f2226;
    border: 1px solid #3a3f44;
    color: #ddd;
    font-size: 0.9rem;
    max-width: 400px;
    padding: 8px 12px;
    margin-bottom: 10px;
}
.node-info div {
    margin-bottom: 3px;
}
.node-info strong {
    color: #9fd4ff;
    font-weight: 600;
}

/* --- Charts --- */
.chart-container {
    width: 100%;
    height: 320px;
    margin-bottom: 25px;
    border: 1px solid #3a3f44;
    border-radius: 8px;
    overflow: hidden;
    background-color: #16191d;
}
.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1f2226;
    padding: 6px 12px;
    font-weight: bold;
    border-bottom: 1px solid #333;
    font-size: 1rem;
    letter-spacing: 0.5px;
}
.chart-actions button {
    background: rgba(255,255,255,0.05);
    border: 1px solid #555;
    border-radius: 4px;
    color: #ccc;
    font-size: 0.8rem;
    padding: 2px 6px;
    cursor: pointer;
    transition: background 0.2s;
}
.chart-actions button:hover {
    color: #fff;
    background: rgba(255,255,255,0.15);
    border-color: #888;
}

/* --- Table --- */
.packet-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    color: #e4e9ee;
}
.packet-table th, .packet-table td {
    border: 1px solid #3a3f44;
    padding: 6px 10px;
    text-align: left;
}
.packet-table th {
    background-color: #1f2226;
    font-weight: bold;
}
.packet-table tr:nth-of-type(odd) { background-color: #272b2f; }
.packet-table tr:nth-of-type(even) { background-color: #212529; }

.port-tag {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #fff;
}
.port-1  { background-color: #007bff; }
.port-3  { background-color: #28a745; }
.port-4  { background-color: #ffc107; color:#000; }
.port-5  { background-color: #dc3545; }
.port-6  { background-color: #20c997; }
.port-67 { background-color: #17a2b8; }
.port-70 { background-color: #ff7043; }
.port-71 { background-color: #ff66cc; }
.port-0, .port-unknown { background-color: #6c757d; }

.to-mqtt { font-style: italic; color: #aaa; }
.payload-row { display: none; background-color: #1b1e22; }
.payload-cell { padding: 8px 12px; font-family: monospace; white-space: pre-wrap; color: #b0bec5; border-top: none; }
.packet-table tr.expanded + .payload-row { display: table-row; }
.toggle-btn { cursor: pointer; color: #aaa; margin-right: 6px; font-weight: bold; }
.toggle-btn:hover { color: #fff; }

/* --- Chart modal --- */
#chartModal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.9); z-index:9999;
    align-items:center; justify-content:center;
}
#chartModal > div {
    background:#1b1e22; border-radius:8px;
    width:90%; height:85%; padding:10px;
}
{% endblock %}

{% block body %}
<div class="container">
    <h5 class="mb-3">üì° Node Feed: <span id="nodeLabel"></span></h5>

    <!-- Node Info -->
    <div id="node-info" class="node-info p-3 rounded">
        <div><strong>Node ID:</strong> <span id="info-node-id">‚Äî</span></div>
        <div><strong>Channel:</strong> <span id="info-channel">‚Äî</span></div>
        <div><strong>HW Model:</strong> <span id="info-hw-model">‚Äî</span></div>
        <div><strong>Role:</strong> <span id="info-role">‚Äî</span></div>
        <div><strong>Last Update:</strong> <span id="info-last-update">‚Äî</span></div>
    </div>

    <!-- Map -->
    <div id="map" style="min-height:400px;"></div>

    <!-- Charts -->
    <div class="chart-container">
        <div class="chart-header">üîã Battery & Voltage
            <div class="chart-actions">
                <button onclick="expandChart('battery_voltage')">Expand</button>
                <button onclick="exportCSV('battery_voltage')">Export CSV</button>
            </div>
        </div>
        <div id="chart_battery_voltage" style="height:260px;"></div>
    </div>

    <div class="chart-container">
        <div class="chart-header">üì∂ Air & Channel Utilization
            <div class="chart-actions">
                <button onclick="expandChart('air_channel')">Expand</button>
                <button onclick="exportCSV('air_channel')">Export CSV</button>
            </div>
        </div>
        <div id="chart_air_channel" style="height:260px;"></div>
    </div>

    <div id="env_chart_container" class="chart-container" style="display:none;">
        <div class="chart-header">üå°Ô∏è Environment Metrics
            <div class="chart-actions">
                <button onclick="expandChart('environment')">Expand</button>
                <button onclick="exportCSV('environment')">Export CSV</button>
            </div>
        </div>
        <div id="chart_environment" style="height:260px;"></div>
    </div>

    <!-- Table -->
    <table class="packet-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Packet ID</th>
                <th>From</th>
                <th>To</th>
                <th>Port</th>
            </tr>
        </thead>
        <tbody id="packet_list"></tbody>
    </table>
</div>

<!-- Modal -->
<div id="chartModal">
    <div>
        <div style="text-align:right;">
            <button onclick="closeModal()" style="background:none;border:none;color:#ccc;">‚úñ</button>
        </div>
        <div id="modalChart" style="width:100%; height:90%;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script>
let nodeMap={}, nodePositions={}, map, markers={}, chartData={};
let allNodes=[];
let fromNodeId=new URLSearchParams(window.location.search).get("from_node_id");
if(!fromNodeId){const parts=window.location.pathname.split("/");fromNodeId=parts[parts.length-1];}

// --- Load nodes ---
async function loadNodes(){
    try{
        const res=await fetch("/api/nodes");
        if(!res.ok){console.error("Failed /api/nodes",res.status);return;}
        const data=await res.json();
        allNodes=data.nodes||[];
        console.log(`Loaded ${allNodes.length} nodes`);

        for(const n of allNodes){
            const name=n.long_name||n.short_name||n.id||n.node_id;
            nodeMap[n.node_id]=name;
            if(n.last_lat&&n.last_long)
                nodePositions[n.node_id]=[n.last_lat/1e7,n.last_long/1e7];
        }
        nodeMap[4294967295]="All";
        document.getElementById("nodeLabel").textContent=nodeMap[fromNodeId]||fromNodeId;
    }catch(err){console.error("Error loading nodes:",err);}
}

// --- Load single node info from cached list ---
async function loadNodeInfo(){
    try{
        if(!allNodes.length) await loadNodes();
        const node=allNodes.find(n=>String(n.node_id)===String(fromNodeId));
        if(!node){console.warn("Node not found",fromNodeId);
            document.getElementById("node-info").style.display="none";return;}
        console.log("Loaded node info:",node);

        document.getElementById("info-node-id").textContent=node.id||node.node_id||"‚Äî";
        document.getElementById("info-channel").textContent=node.channel||"‚Äî";
        document.getElementById("info-hw-model").textContent=node.hw_model||"‚Äî";
        document.getElementById("info-role").textContent=node.role||"‚Äî";
        const last=node.last_update?new Date(node.last_update).toLocaleString([],{
            month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"‚Äî";
        document.getElementById("info-last-update").textContent=last;
        document.getElementById("node-info").style.display="block";
    }catch(err){
        console.error("Failed to load node info:",err);
        document.getElementById("node-info").style.display="none";
    }
}

// --- Helpers ---
function nodeLink(id){
    if(id===4294967295) return `<span class="to-mqtt">All</span>`;
    if(id===1) return `<span class="to-mqtt">Direct to MQTT</span>`;
    return `<a href="/firehose/node/${id}" style="text-decoration:underline; color:inherit;">${nodeMap[id]||id}</a>`;
}
function portLabel(p){
    const names={0:"UNKNOWN APP",1:"Text",3:"Position",4:"Node Info",5:"Routing",6:"Admin",67:"Telemetry",70:"Traceroute",71:"Neighbor"};
    const label=names[p]||"Unknown";
    return `<span class="port-tag port-${p}">${label}</span>`;
}
function formatLocalTime(us){
    return new Date(us/1000).toLocaleString([], {month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
}

// --- Map ---
function initMap(){
    map=L.map('map',{preferCanvas:true}).setView([37.7749,-122.4194],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    console.log("‚úÖ Map initialized");
}
function addMarker(id,lat,lon,label,color="red"){
    if(isNaN(lat)||isNaN(lon))return;
    nodePositions[id]=[lat,lon];
    const m=L.circleMarker([lat,lon],{radius:5,color,fillColor:color,fillOpacity:1}).addTo(map).bindPopup(label);
    markers[id]=m;m.bringToFront();
}
function drawNeighbors(src,nids){
    const s=nodePositions[src]; if(!s)return;
    for(const nid of nids){
        const pos=nodePositions[nid];
        if(pos){
            addMarker(nid,pos[0],pos[1],nodeMap[nid]||nid,"blue");
            L.polyline([s,pos],{color:'gray',weight:1}).addTo(map);
        }
    }
}
function ensureMapVisible(){
    if(!map)return;
    requestAnimationFrame(()=>{
        map.invalidateSize();
        const group=L.featureGroup(Object.values(markers));
        if(group.getLayers().length>0) map.fitBounds(group.getBounds(),{padding:[20,20]});
        else map.setView([37.7749,-122.4194],11);
    });
}

// --- Packets ---
async function loadPackets(){
    const url=new URL("/api/packets",window.location.origin);
    url.searchParams.set("from_node_id",fromNodeId);
    url.searchParams.set("limit",200);
    const res=await fetch(url); if(!res.ok)return;
    const data=await res.json(); const list=document.getElementById("packet_list");
    for(const pkt of (data.packets||[]).reverse()){
        const safePayload=(pkt.payload||"").replace(/[<>]/g,m=>m=="<"?"&lt;":"&gt;");
        const localTime=formatLocalTime(pkt.import_time_us);
        const fromCell=nodeLink(pkt.from_node_id),toCell=nodeLink(pkt.to_node_id);
        if(pkt.portnum===3&&pkt.payload){
            const lat=pkt.payload.match(/latitude_i:\s*(-?\d+)/),lon=pkt.payload.match(/longitude_i:\s*(-?\d+)/);
            if(lat&&lon){addMarker(pkt.from_node_id,parseInt(lat[1])/1e7,parseInt(lon[1])/1e7,nodeMap[pkt.from_node_id]||pkt.from_node_id,"red");}
        }
        if(pkt.portnum===71&&pkt.payload){
            const nids=[]; const re=/neighbors\s*\{\s*node_id:\s*(\d+)/g; let m;
            while((m=re.exec(pkt.payload))!==null)nids.push(parseInt(m[1]));
            drawNeighbors(pkt.from_node_id,nids);
        }
        list.insertAdjacentHTML("afterbegin",`
<tr class="packet-row">
<td>${localTime}</td>
<td><span class="toggle-btn">‚ñ∂</span> <a href="/packet/${pkt.id}" style="text-decoration:underline; color:inherit;">${pkt.id}</a></td>
<td>${fromCell}</td><td>${toCell}</td><td>${portLabel(pkt.portnum)}</td>
</tr><tr class="payload-row"><td colspan="5" class="payload-cell">${safePayload}</td></tr>`);
    }
}

// --- Charts ---
async function loadTelemetryCharts(){
    const url=`/api/packets?portnum=67&from_node_id=${fromNodeId}`;
    const res=await fetch(url); if(!res.ok)return;
    const data=await res.json();
    const packets=data.packets||[];
    chartData={times:[],battery:[],voltage:[],airUtil:[],chanUtil:[],temperature:[],humidity:[],pressure:[]};
    for(const pkt of packets.reverse()){
        const pl=pkt.payload||"",t=new Date(pkt.import_time_us/1000);
        chartData.times.push(t.toLocaleString([], {month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}));
        chartData.battery.push(parseFloat(pl.match(/battery_level:\s*([\d.]+)/)?.[1]||NaN));
        chartData.voltage.push(parseFloat(pl.match(/voltage:\s*([\d.]+)/)?.[1]||NaN));
        chartData.airUtil.push(parseFloat(pl.match(/air_util_tx:\s*([\d.]+)/)?.[1]||NaN));
        chartData.chanUtil.push(parseFloat(pl.match(/channel_utilization:\s*([\d.]+)/)?.[1]||NaN));
        chartData.temperature.push(parseFloat(pl.match(/temperature:\s*([\d.]+)/)?.[1]||NaN));
        chartData.humidity.push(parseFloat(pl.match(/relative_humidity:\s*([\d.]+)/)?.[1]||NaN));
        chartData.pressure.push(parseFloat(pl.match(/barometric_pressure:\s*([\d.]+)/)?.[1]||NaN));
    }

    const makeLine=(name,color,data,yAxisIndex=0)=>({
        name,type:'line',smooth:true,connectNulls:true,yAxisIndex,
        showSymbol:true,symbol:'circle',symbolSize:8,
        lineStyle:{width:2,color,shadowColor:color.replace('1)','0.4)'),shadowBlur:8,shadowOffsetY:3},
        itemStyle:{color,borderColor:'#000',borderWidth:1},
        areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[
            {offset:0,color:color.replace('1)','0.65)')},
            {offset:0.5,color:color.replace('1)','0.35)')},
            {offset:1,color:'rgba(0,0,0,0)'}
        ])},
        data:data.map(v=>isNaN(v)?null:v)
    });

    const chart1=echarts.init(document.getElementById('chart_battery_voltage'));
    chart1.setOption({
        tooltip:{trigger:'axis'},
        legend:{data:['Battery Level','Voltage'],textStyle:{color:'#ccc'}},
        xAxis:{type:'category',data:chartData.times,axisLabel:{color:'#ccc'}},
        yAxis:[{type:'value',name:'Battery (%)',axisLabel:{color:'#ccc'}},{type:'value',name:'Voltage (V)',axisLabel:{color:'#ccc'}}],
        series:[
            makeLine('Battery Level','rgba(255,214,82,1)',chartData.battery),
            makeLine('Voltage','rgba(79,155,255,1)',chartData.voltage,1)
        ]
    });

    const chart2=echarts.init(document.getElementById('chart_air_channel'));
    chart2.setOption({
        tooltip:{trigger:'axis'},
        legend:{data:['Air Util Tx','Channel Utilization'],textStyle:{color:'#ccc'}},
        xAxis:{type:'category',data:chartData.times,axisLabel:{color:'#ccc'}},
        yAxis:{type:'value',name:'%',axisLabel:{color:'#ccc'}},
        series:[
            makeLine('Air Util Tx','rgba(138,255,108,1)',chartData.airUtil),
            makeLine('Channel Utilization','rgba(255,102,204,1)',chartData.chanUtil)
        ]
    });

    let chart3=null;
    if(chartData.temperature.some(v=>!isNaN(v))){
        document.getElementById("env_chart_container").style.display="block";
        chart3=echarts.init(document.getElementById('chart_environment'));
        chart3.setOption({
            tooltip:{trigger:'axis'},
            legend:{data:['Temperature (¬∞C)','Humidity (%)','Pressure (hPa)'],textStyle:{color:'#ccc'}},
            xAxis:{type:'category',data:chartData.times,axisLabel:{color:'#ccc'}},
            yAxis:[{type:'value',name:'¬∞C / %',axisLabel:{color:'#ccc'}},{type:'value',name:'hPa',axisLabel:{color:'#ccc'}}],
            series:[
                makeLine('Temperature (¬∞C)','rgba(255,138,82,1)',chartData.temperature),
                makeLine('Humidity (%)','rgba(138,255,108,1)',chartData.humidity),
                makeLine('Pressure (hPa)','rgba(79,155,255,1)',chartData.pressure,1)
            ]
        });
    }

    window.addEventListener("resize",()=>{[chart1,chart2,chart3].forEach(c=>{if(c)c.resize();});});
}

// --- Expand/Export ---
function expandChart(type){
    const modal=document.getElementById('chartModal');
    const modalChart=echarts.init(document.getElementById('modalChart'));
    modal.style.display="flex";
    const opt=echarts.getInstanceByDom(document.getElementById(`chart_${type}`)).getOption();
    modalChart.setOption(opt); modalChart.resize();
}
function closeModal(){document.getElementById('chartModal').style.display="none";}
function exportCSV(type){
    const rows=[["Time"]];
    if(type==="battery_voltage"){rows[0].push("Battery Level","Voltage");
        for(let i=0;i<chartData.times.length;i++)rows.push([chartData.times[i],chartData.battery[i],chartData.voltage[i]]);}
    else if(type==="air_channel"){rows[0].push("Air Util Tx","Channel Utilization");
        for(let i=0;i<chartData.times.length;i++)rows.push([chartData.times[i],chartData.airUtil[i],chartData.chanUtil[i]]);}
    else{rows[0].push("Temperature","Humidity","Pressure");
        for(let i=0;i<chartData.times.length;i++)rows.push([chartData.times[i],chartData.temperature[i],chartData.humidity[i],chartData.pressure[i]]);}
    const csv=rows.map(r=>r.join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const link=document.createElement("a");link.href=URL.createObjectURL(blob);
    link.download=`${type}_${fromNodeId}.csv`;link.click();
}

// --- Expand payload rows ---
document.addEventListener("click",e=>{
    const btn=e.target.closest(".toggle-btn");
    if(!btn)return;
    const row=btn.closest(".packet-row");
    row.classList.toggle("expanded");
    btn.textContent=row.classList.contains("expanded")?"‚ñº":"‚ñ∂";
});

// --- Init ---
document.addEventListener("DOMContentLoaded",async()=>{
    requestAnimationFrame(async ()=>{
        initMap();
        await loadNodes();
        await loadNodeInfo();
        await loadPackets();
        await loadTelemetryCharts();
        ensureMapVisible();
        setTimeout(ensureMapVisible,1000);
        window.addEventListener("resize",ensureMapVisible);
        window.addEventListener("focus",ensureMapVisible);
    });
});
</script>
{% endblock %}
