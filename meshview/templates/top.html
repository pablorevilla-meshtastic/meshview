{% extends "base.html" %}

{% block css %}
<style>
    body { background-color: #121212; color: #ddd; }
    h1 { text-align: center; margin-top: 20px; color: #fff; }

    .top-container {
        max-width: 1100px;
        margin: 25px auto;
        padding: 0 15px;
    }

    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
    }

    .filter-bar select,
    .filter-bar input {
        background-color: #1f2327;
        border: 1px solid #444;
        color: #ddd;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    table th, table td {
        padding: 12px;
        border: 1px solid #444;
        text-align: left;
        color: #ddd;
    }

    table th { background-color: #333; }
    table tbody tr:nth-child(odd) { background-color: #272b2f; }
    table tbody tr:nth-child(even) { background-color: #212529; }
    table tbody tr:hover { background-color: #555; cursor: pointer; }

    .node-link {
        color: #9fd4ff;
        text-decoration: none;
    }
    .node-link:hover { text-decoration: underline; }

    .good-x { color: #81ff81; font-weight: bold; }
    .ok-x   { color: #e8e86d; font-weight: bold; }
    .bad-x  { color: #ff6464; font-weight: bold; }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block body %}

<h1 data-translate-lang="top_traffic_nodes">Top Nodes Traffic</h1>

<div class="top-container">

    <div class="filter-bar">
        <div>
            <label for="channelFilter" data-translate-lang="channel">Channel:</label>
            <select id="channelFilter" class="form-select form-select-sm"></select>
        </div>

        <div>
            <label for="nodeSearch" data-translate-lang="search">Search:</label>
            <input id="nodeSearch"
                   type="text"
                   class="form-control form-control-sm"
                   placeholder="Search nodes..."
                   data-translate-lang="search_placeholder"
                   style="width:180px;">
        </div>
    </div>

    <div style="margin-bottom:10px; font-weight:bold;">
        <span data-translate-lang="showing_nodes">Showing</span>
        <span id="node-count">0</span>
        <span data-translate-lang="nodes_suffix">nodes</span>
    </div>

    <div class="table-responsive">
        <table id="nodesTable">
            <thead>
                <tr>
                    <th data-translate-lang="long_name">Long Name</th>
                    <th data-translate-lang="short_name">Short Name</th>
                    <th data-translate-lang="channel">Channel</th>
                    <th data-translate-lang="packets_sent">Sent (24h)</th>
                    <th data-translate-lang="times_seen">Seen (24h)</th>
                    <th data-translate-lang="avg_gateways">Avg Gateways</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="pagination">
        <button id="prevPage" class="btn btn-sm btn-secondary">Prev</button>
        <span id="pageInfo"></span>
        <button id="nextPage" class="btn btn-sm btn-secondary">Next</button>
    </div>

</div>

<script>
/* ======================================================
   TRANSLATIONS
   ====================================================== */
let topTranslations = {};

function applyTranslationsTop(dict, root=document) {
    root.querySelectorAll("[data-translate-lang]").forEach(el => {
        const key = el.dataset.translateLang;
        if (!dict[key]) return;

        if (el.tagName === "INPUT" && el.placeholder !== undefined) {
            el.placeholder = dict[key];
        } else {
            el.textContent = dict[key];
        }
    });
}

async function loadTranslationsTop() {
    const cfg = await window._siteConfigPromise;
    const lang = cfg?.site?.language || "en";
    const res = await fetch(`/api/lang?lang=${lang}&section=top`);
    topTranslations = await res.json();
    applyTranslationsTop(topTranslations);
}

/* ======================================================
   DATA + PAGINATION
   ====================================================== */
let ALL_NODES = [];

const PAGE_SIZE = 20;
let currentPage = 1;
let totalPages = 1;

// Cache node stats to avoid refetching
const STATS_CACHE = {};

/* ======================================================
   LOADERS
   ====================================================== */
async function loadNodes() {
    const res = await fetch("/api/nodes");
    const data = await res.json();
    ALL_NODES = data.nodes || [];
}

async function loadChannels() {
    const res = await fetch("/api/channels");
    const data = await res.json();
    const select = document.getElementById("channelFilter");

    select.innerHTML = "";

    for (const ch of data.channels || []) {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        select.appendChild(opt);
    }

    select.value = "LongFast";
}

/* ======================================================
   STATS
   ====================================================== */
async function fetchNodeStats(nodeId) {
    if (STATS_CACHE[nodeId]) return STATS_CACHE[nodeId];

    const res = await fetch(
        `/api/stats/count?from_node=${nodeId}&period_type=day&length=1`
    );
    const data = await res.json();

    const sent = data.total_packets || 0;
    const seen = data.total_seen || 0;
    const avg  = seen / Math.max(sent, 1);

    STATS_CACHE[nodeId] = { sent, seen, avg };
    return STATS_CACHE[nodeId];
}

function avgClass(v) {
    if (v >= 10) return "good-x";
    if (v >= 2)  return "ok-x";
    return "bad-x";
}

/* ======================================================
   RENDER TABLE (PAGINATED)
   ====================================================== */
async function renderTable() {
    const tbody = document.querySelector("#nodesTable tbody");
    tbody.innerHTML = "";

    const channel = document.getElementById("channelFilter").value;
    const search  = document.getElementById("nodeSearch").value.toLowerCase();

    let filtered = ALL_NODES.filter(n => n.channel === channel);

    if (search) {
        filtered = filtered.filter(n =>
            (n.long_name || "").toLowerCase().includes(search) ||
            (n.short_name || "").toLowerCase().includes(search) ||
            String(n.node_id).includes(search)
        );
    }

    totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    currentPage = Math.min(currentPage, totalPages);

    const start = (currentPage - 1) * PAGE_SIZE;
    const pageNodes = filtered.slice(start, start + PAGE_SIZE);

    const rows = await Promise.all(pageNodes.map(async n => {
        const stats = await fetchNodeStats(n.node_id);
        if (stats.sent === 0 && stats.seen === 0) return null;

        const tr = document.createElement("tr");
        tr.onclick = () => location.href = `/node/${n.node_id}`;

        tr.innerHTML = `
            <td>
                <a class="node-link" href="/node/${n.node_id}"
                   onclick="event.stopPropagation()">
                    ${n.long_name || n.node_id}
                </a>
            </td>
            <td>${n.short_name || ""}</td>
            <td>${n.channel || ""}</td>
            <td>${stats.sent}</td>
            <td>${stats.seen}</td>
            <td>
                <span class="${avgClass(stats.avg)}">
                    ${stats.avg.toFixed(1)}
                </span>
            </td>
        `;
        return tr;
    }));

    rows.filter(Boolean).forEach(tr => tbody.appendChild(tr));

    document.getElementById("node-count").textContent = filtered.length;
    document.getElementById("pageInfo").textContent =
        `Page ${currentPage} / ${totalPages}`;

    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage === totalPages;
}

/* ======================================================
   INIT
   ====================================================== */
document.addEventListener("DOMContentLoaded", async () => {
    await loadTranslationsTop();
    await loadNodes();
    await loadChannels();

    document.getElementById("nodeSearch").addEventListener("input", () => {
        currentPage = 1;
        renderTable();
    });

    document.getElementById("channelFilter").addEventListener("change", () => {
        currentPage = 1;
        renderTable();
    });

    document.getElementById("prevPage").onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    };

    document.getElementById("nextPage").onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    };

    renderTable();
});
</script>

{% endblock %}
